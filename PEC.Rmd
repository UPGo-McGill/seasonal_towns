---
fig_caption: yes
---


```{r, include = FALSE}
source("R/01_helper_functions.R")
# input variables (cityname, citycode, End_date, Start_date) into data import before knitting the script
options(cancensus.api_key = "CensusMapper_4be2cf3bf91d0cabf967f4934dbdc63b")
source("R/02_data_import.R")
source("R/03__mapping.R")
source("R/04_graphing.R")
# Set USD to CAD exchange rate
exchange_rate <- 1.34
# Format numbers
options(scipen=999)
```

``` {r, include = FALSE}
# Set up timeframes
year_prior <- as.POSIXlt(End_date)
year_prior$year <- year_prior$year - 1
year_prior_prior <- as.POSIXlt(year_prior)
year_prior_prior$year <- year_prior$year - 1
```

# Airbnb and `r cityname`
### Urban Politics and Governance Research Group
### `r format(End_date, format = "%B %Y")`


**Airbnb Today** 

Airbnb listings are a common presence in `r cityname`, with `r round(daily %>% 
  filter(Date == End_date) %>% 
  group_by(Property_ID) %>% 
  nrow())` active listings  on `r format(End_date, format="%B %d %Y")`, averaging `r round(daily %>% 
  filter(Date <= End_date & Date >= year_prior) %>% 
  group_by(Date) %>% 
  summarize(Listings = n()) %>%
  summarise(mean_Listings = mean(Listings)))` over the past twelve months. The corresponding listings have generated approximately $`r prettyNum(round(daily %>% 
                  filter(Date <= End_date & 
                           Date >= year_prior &
                           Status == "R" ) %>%
                  summarise(sum_revenue = sum(Price, na.rm = TRUE) * exchange_rate), digits = -3), big.mark = ",", small.mark = ",")` in revenue over the same time period. 
                  
*Figure 1* shows the distribution of Airbnb listings throughout `r cityname`, by listing type and revenue. As Airbnb hides the exact location of the listings, the locations may be obfuscated by up to 200 meters.

```{r, echo = FALSE, fig.cap="\\label{figure1} Figure 1: Active Airbnb listings by listing type and revenue", fig.align = 'center', message = FALSE}
figure1
```

**The Evolution of Airbnb**

Airbnb has had `r ifelse((daily %>% 
         filter(Date == End_date) %>% 
         group_by(Property_ID) %>% 
         nrow()) > (daily %>% 
  filter(Date == Start_date) %>% 
  group_by(Property_ID) %>% 
  nrow()), "an increasing", "a decreasing")` presence in `r cityname`, with *Figure 2* showing its evolution from `r format(Start_date, format="%B %d %Y")` to `r format(End_date, format="%B %d %Y")`. It is evident that the number of listings has dramatically `r  ifelse((daily %>% 
         filter(Date == End_date) %>% 
         group_by(Property_ID) %>% 
         nrow()) > (daily %>% 
  filter(Date == Start_date) %>% 
  group_by(Property_ID) %>% 
  nrow()), "increased", "decreased")`
 over the past years.  

``` {r, echo = FALSE, fig.cap="\\label{figure2} Figure 2: The number of active Airbnb listings over time", fig.align = 'center'} 
figure2
```

**Revenue Distribution**

``` {r, include = FALSE}
host_revenue_prior <-
  daily %>%
  filter(Date >= year_prior_prior, Date <= year_prior, Status == "R") %>%
  group_by(Airbnb_HID) %>%
  summarize(rev = sum(Price)) %>%
  filter(rev > 0) %>%
  summarize(
    `Top 1%`  = sum(rev[rev > quantile(rev, c(0.99))] / sum(rev)),
    `Top 5%`  = sum(rev[rev > quantile(rev, c(0.95))] / sum(rev)),
    `Top 10%` = sum(rev[rev > quantile(rev, c(0.90))] / sum(rev))) %>% 
  gather(`Top 1%`, `Top 5%`, `Top 10%`, key = "percentile", value = "value") %>% 
  mutate(percentile = factor(percentile, levels = c('Top 1%', 'Top 5%', 'Top 10%')))
```


Total revenue generated by active Airbnb listings in `r cityname` has `r ifelse((daily %>% 
  filter(Date <= End_date & 
           Date >= year_prior &
           Status == "R" ) %>%
  summarise(sum_revenue = sum(Price, na.rm = TRUE) * exchange_rate)) >
(daily %>% 
  filter(Date <= year_prior & 
           Date >= year_prior_prior &
           Status == "R" ) %>%
  summarise(sum_revenue = sum(Price, na.rm = TRUE) * exchange_rate)), "increased", "decreased")` to $`r prettyNum(round(daily %>% 
                  filter(Date <= End_date & 
                           Date >= year_prior &
                           Status == "R" ) %>%
                  summarise(sum_revenue = sum(Price, na.rm = TRUE) * exchange_rate), digits = -3), big.mark = ",", small.mark = ",")` over the past twelve months, from $`r prettyNum(round(daily %>% 
                  filter(Date <= year_prior & 
                           Date >= year_prior_prior &
                           Status == "R" ) %>%
                  summarise(sum_revenue = sum(Price, na.rm = TRUE) * exchange_rate), digits = -3), big.mark = ",", small.mark = ",")` the twelve months previous.

Currently, the share of Airbnb revenue is unevenly distributed amongst hosts (*Figure 3*). The highest earning 10% of hosts brought in `r round(host_revenue[3,2]*100, digits = 1)`% of total Airbnb revenue in the past twelve months, compared to `r round(host_revenue_prior[3,2]*100, digits = 1)`% the year prior.

``` {r, echo = FALSE, fig.cap="\\label{figure3} Figure 3: The distribution of total Airbnb revenue over the past twelve months", fig.align = 'center'} 
figure3

```


**Housing Loss** 

Listings consist of three types: entire homes or apartments, private rooms, or shared rooms. Entire homes or apartments represent housing that has likely been removed from the long-term rental market. 
`r round(nrow(daily %>% 
       filter(Date == End_date) %>% 
       group_by(Property_ID) %>% 
       filter(Listing_Type == "Entire home/apt"))*100/
  nrow(daily %>% 
         filter(Date == End_date)), digits = 1)`% of listings are entire homes or apartments. This percentage has `r ifelse((nrow(daily %>% 
       filter(Date == End_date) %>% 
       group_by(Property_ID) %>% 
       filter(Listing_Type == "Entire home/apt"))*100/
  nrow(daily %>% 
         filter(Date == End_date)))>(nrow(daily %>% 
       filter(Date == year_prior) %>% 
       group_by(Property_ID) %>% 
       filter(Listing_Type == "Entire home/apt"))*100/
  nrow(daily %>% 
         filter(Date == year_prior))), "increased", "decreased")` over the past twelve months from `r round(nrow(daily %>% 
       filter(Date == year_prior) %>% 
       group_by(Property_ID) %>% 
       filter(Listing_Type == "Entire home/apt"))*100/
  nrow(daily %>% 
         filter(Date == year_prior)), digits = 1)`%. 
Though private rooms and shared rooms are often indicative of hosts sharing their primary residence, this is not always the case. Ghost hotels, three or more private room listings in the same housing unit, also contribute to housing loss, as the separate private room listings make up an entire housing unit removed from the long-term rental housing market.
         
         
When considering both ghost hotels and entire home and apartment listings, it is estimated that Airbnb has removed `r 
st_drop_geometry(strr_ghost(property, Property_ID, Airbnb_HID, Created, Scraped, year_prior,
             End_date, listing_type = Listing_Type) %>% 
  filter(date == End_date) %>% 
  group_by(ghost_ID) %>% 
  summarize(n = sum(housing_units)) %>% 
  ungroup() %>% 
  summarize(GH_housing_loss = sum(n))) +
nrow(daily %>% 
  filter(Date == End_date) %>% 
  inner_join(property, .) %>% 
  filter(FREH == TRUE)) ` housing units from the long-term rental market over the past year, `r ifelse((st_drop_geometry(strr_ghost(property, Property_ID, Airbnb_HID, Created, Scraped, year_prior,
             End_date, listing_type = Listing_Type) %>% 
  filter(date == End_date) %>% 
  group_by(ghost_ID) %>% 
  summarize(n = sum(housing_units)) %>% 
  ungroup() %>% 
  summarize(GH_housing_loss = sum(n))) +
nrow(daily %>% 
  filter(Date == End_date) %>% 
  inner_join(property, .) %>% 
  filter(FREH == TRUE))) > (st_drop_geometry(strr_ghost(property, Property_ID, Airbnb_HID, Created, Scraped, year_prior_prior,
             year_prior, listing_type = Listing_Type) %>% 
  filter(date == year_prior) %>% 
  group_by(ghost_ID) %>% 
  summarize(n = sum(housing_units)) %>% 
  ungroup() %>% 
  summarize(GH_housing_loss = sum (n))) +
  nrow(daily %>% 
         filter(Date == year_prior) %>% 
         inner_join(property, .) %>% 
         filter(FREH == TRUE))), "increasing", "decreasing")` from `r 
st_drop_geometry(strr_ghost(property, Property_ID, Airbnb_HID, Created, Scraped, year_prior_prior,
             year_prior, listing_type = Listing_Type) %>% 
  filter(date == year_prior) %>% 
  group_by(ghost_ID) %>% 
  summarize(n = sum(housing_units)) %>% 
  ungroup() %>% 
  summarize(GH_housing_loss = sum (n))) +
  nrow(daily %>% 
         filter(Date == year_prior) %>% 
         inner_join(property, .) %>% 
         filter(FREH == TRUE))` units the year prior. 

As more units are converted into short-term rentals, Airbnb increasingly contributes to the removal of housing units from the long-term rental market. 

